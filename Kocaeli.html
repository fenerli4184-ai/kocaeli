<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="default-src * data:; style-src * 'self' 'unsafe-inline' https://fonts.googleapis.com; script-src * 'self' 'unsafe-inline' 'unsafe-eval'; connect-src *;">
    <title>Kocaeli Deniz UlaÅŸÄ±m</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght400;500;600&display=swap" rel="stylesheet">

    <style>
        /* CSS TanÄ±mlamalarÄ± */
        :root{--p:#006994;--pl:#e6f2f9;--a:#ff6f00;--t:#1a1a1a;--bg:#f8fbff;--c:#fff;--s:0 2px 8px rgba(0,0,0,.1);--r:12px}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--t);min-height:100vh;padding:8px 12px;font-size:14px;line-height:1.4}
        .con{max-width:480px;margin:0 auto;position:relative}
        header{text-align:center;margin:8px 0 12px}
        
        h1{font-size:1.4rem;color:var(--p);display:flex;align-items:center;justify-content:center;gap:6px;font-weight:600}
        h1 span{font-size:1.6rem}
        
        #refreshIcon {color: var(--a);font-size: 1.8rem;cursor: pointer;padding-left: 10px;transition: transform 0.3s;}
        .refreshing {animation: spin 1s linear infinite;pointer-events: none;}
        @keyframes spin {from { transform: rotate(0deg); } to { transform: rotate(360deg); }}
        
        .info{font-size:.75rem;color:#666;margin-top:2px;text-align:center}
        .info a { color: var(--p);text-decoration: none;font-weight: 600;}
        .card{background:var(--c);border-radius:var(--r);padding:12px;margin-bottom:12px;box-shadow:var(--s)}
        
        select{width:100%;padding:9px 10px;margin:4px 0;font-size:.9rem;border:1px solid #ddd;border-radius:10px;background:#fff;height:40px;color:#444}
        .iskelesecim{display:flex;gap:8px;position:relative;align-items:center;height:48px;padding:4px 0}
        .swap-btn{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:24px;height:24px;background:var(--a);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.9rem;cursor:pointer;z-index:10;box-shadow:0 1px 4px rgba(0,0,0,.2)}
        
        .live{font-size:.75rem;color:var(--a);text-align:center;margin:4px 0;font-weight:600}
        /* res sÄ±nÄ±fÄ± titreme yapmasÄ±n diye kaldÄ±rÄ±lmÄ±ÅŸtÄ±r */
        .rota-kutu {margin-bottom: 12px;padding: 10px;border-radius: 12px;box-shadow: 0 1px 4px rgba(0,0,0,.1);background: #fff;}
        .rota-baslik {display: flex;justify-content: space-between;align-items: center;font-weight: 600;color: var(--p);margin-bottom: 8px;padding-bottom: 5px;border-bottom: 1px solid var(--pl);}
        .sefer-listesi {list-style: none;padding: 0;margin: 0;display: flex;flex-wrap: wrap;gap: 8px;}
        .trip {font-size: 0.9rem;font-weight: 500;color: var(--t);padding: 4px 8px;border-radius: 6px;background: var(--pl);border: 1px solid var(--p);display: inline-block;}
        .trip.next {background: var(--a);color: #fff;border-color: var(--a);font-weight: 600;box-shadow: 0 1px 3px rgba(255,111,0,.4);}
        .trip.passed{opacity:.5;background: #eee;color: #888;border-color: #ccc;}
        .gun-etiketi {font-size: 0.7rem;font-weight: 600;background: var(--p);color: #fff;padding: 2px 6px;border-radius: 4px;}

        .empty{text-align:center;color:#888;padding:20px}
        .hidden{display:none}
        
        /* DUYURU KUTUSU CSS STÄ°LLERÄ° */
        .duyuru-style {
            background:#d32f2f;
            color:#fff;
            padding:12px;
            text-align:center;
            margin:10px;
            border-radius:8px;
            font-weight:600;
        }

        /* ðŸš¨ KRÄ°TÄ°K DÃœZELTME: SÃ¼rekli gÃ¶rsel titremeyi Ã¶nlemek iÃ§in animasyon kaldÄ±rÄ±ldÄ±. */
        /*.announcement-pulse {animation: pulse 2s infinite;}*/
        /*@keyframes pulse {0%, 100% {opacity: 1}50% {opacity: 0.85}}*/ 

        /* Rezervasyon Butonu Stili */
        #rezervasyonBtn {width: 100%;padding: 12px;background: #1e88e5; color: white;border: none;border-radius: 10px;font-size: 1.0rem;font-weight: 600;cursor: pointer;box-shadow: 0 4px 6px rgba(0,0,0,.15);transition: background 0.2s;margin-bottom: 12px;display: flex;align-items: center;justify-content: center;gap: 8px;}
        #rezervasyonBtn:hover:not(:disabled) {background: #1565c0;}
        #rezervasyonBtn:disabled {background: #ccc;color: #666;cursor: not-allowed;box-shadow: none;}
    </style>
</head>
<body>
<div class="con">
    <header>
        <h1>
            <span class="material-icons-round">directions_boat</span> 
            Kocaeli Deniz UlaÅŸÄ±m
            <span class="material-icons-round" id="refreshIcon" onclick="refresher(true)">refresh</span>
        </h1>
        <div class="info">
            <a href="https://kdu.kocaeli.bel.tr/" target="_blank">GÃ¼ncel Tarife (Resmi Site)</a>
        </div>
        <div class="live" id="liveTime"></div>
        <div id="acil-duyuru" class="duyuru-style hidden"></div>
    </header>
    
    <button id="rezervasyonBtn" onclick="window.open(REZERVASYON_URL, '_system')">
        <span class="material-icons-round">calendar_today</span> Deniz Seferi Rezervasyon Yap
    </button>
    
    <div class="card">
        <div class="iskelesecim">
            <select id="baslangicSelect"></select>
            <select id="varisSelect"></select>
            <div class="swap-btn" onclick="degistirYon()"><span class="material-icons-round">swap_horiz</span></div>
        </div>
        <select id="gunSelect">
            <option value="haftaici">Hafta Ä°Ã§i Tarifesi</option>
            <option value="haftasonu">Hafta Sonu Tarifesi</option>
        </select>
    </div>
    
    <div id="sonuc" class="res hidden"></div>
</div>

<script>
// --- GLOBAL DEÄžÄ°ÅžKENLER ---
let mevcutDuyuruMetni = null; 

// --- UYGULAMA AYARLARI ---
const GOOGLE_SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRT-66h_6nYFF_IqhFf0atm2MPgFPBLGid66HVH4QcoJDq54ZCaFAR_ACCAPx-3VHFPMZZwP_QFW488/pub?output=csv";
const DUYURU_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRT-66h_6nYFF_IqhFf0atm2MPgFPBLGid66HVH4QcoJDq54ZCaFAR_ACCAPx-3VHFPMZZwP_QFW488/pub?gid=463559708&single=true&output=csv"; 
const REZERVASYON_URL = "https://kdu.kocaeli.bel.tr/reservation"; 

let seferler = {}; 
let iskeleler = []; 
const resmiTatiller = [
    '2025-01-01','2025-04-23','2025-05-01','2025-05-19', '2025-10-29' 
];

// --- Fonksiyonlar ---

function duyuruyuCek() {
    return new Promise((resolve) => {
        const cacheBuster = Math.floor(Math.random() * 99999);
        const xhr = new XMLHttpRequest();
        xhr.open('GET', `${DUYURU_CSV_URL}&b=${cacheBuster}`, true); 
        xhr.setRequestHeader('Cache-Control', 'no-cache, must-revalidate, max-age=0'); 

        xhr.onload = function() {
            let yeniDuyuruMetni = "";
            if (xhr.status >= 200 && xhr.status < 300) {
                const data = xhr.responseText.trim();
                const satirlar = data.split('\n');
                
                if (satirlar.length > 0) {
                    yeniDuyuruMetni = satirlar[0].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/)[0]?.trim().replace(/^"|"$/g, '') || "";
                }
            }
            
            // Metin deÄŸiÅŸmediyse, DOM manipÃ¼lasyonu yapma (Titremeyi engeller)
            if (yeniDuyuruMetni !== mevcutDuyuruMetni) {
                duyuruGoster(yeniDuyuruMetni); 
                mevcutDuyuruMetni = yeniDuyuruMetni; 
            }

            resolve();
        };

        xhr.onerror = function() {
            if (mevcutDuyuruMetni !== "") {
                duyuruGoster(""); 
                mevcutDuyuruMetni = "";
            }
            resolve();
        };

        xhr.send();
    });
}

function rotaVerileriniGetir() {
    return new Promise((resolve, reject) => {
        const cacheBusterV = Math.floor(Math.random() * 99999);
        const xhr = new XMLHttpRequest();
        xhr.open('GET', `${GOOGLE_SHEET_CSV_URL}&v=${cacheBusterV}`, true); 
        xhr.setRequestHeader('Cache-Control', 'no-cache, must-revalidate, max-age=0'); 

        xhr.onload = function() {
            if (xhr.status >= 200 && xhr.status < 300) {
                const data = xhr.responseText;
                const satirlar = data.split('\n');
                
                seferler = {}; 
                const bulunanIskeleler = new Set(); 

                if (satirlar.length < 2) {
                    iskeleler = [];
                    return resolve();
                }

                for (let i = 1; i < satirlar.length; i++) {
                    const satirVerisi = satirlar[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    let colA = satirVerisi[0]?.trim().replace(/"/g, '') || ''; 
                    
                    if (!colA || !colA.includes('-')) continue; 
                    
                    let rotaGrup = colA; 
                    let gunTipi = rotaGrup.includes("(HS)") || rotaGrup.includes("HAFTA SONU") ? "haftasonu" : "haftaici";
                    let rotaAdi = rotaGrup.replace(/\s*\((H[SÄ°]|Hafta Ä°Ã§i|Hafta Sonu)\)\s*/i, '').replace(/\s*-\s*/g, '-').trim();

                    if (!rotaAdi) continue;

                    if (!seferler[rotaAdi]) {
                        seferler[rotaAdi] = { haftaici: [], haftasonu: [], iptal: false };
                    }
                    
                    let rotaIptal = false;
                    for(let j = 1; j < satirVerisi.length; j++) {
                        let saat = satirVerisi[j]?.trim().replace(/"/g, '') || '';
                        
                        if (saat.toUpperCase().includes("Ä°PTAL") || saat.toUpperCase().includes("IPTAL")) {
                            rotaIptal = true; 
                        } else if (saat.includes(':') && saat.length >= 4) {
                            if (saat.includes(',')) {
                                saat.split(',').forEach(s => {
                                    let temizSaat = s.trim();
                                    if (temizSaat.includes(':') && temizSaat.length >= 4) {
                                        seferler[rotaAdi][gunTipi].push(temizSaat);
                                    }
                                });
                            } else {
                                seferler[rotaAdi][gunTipi].push(saat);
                            }
                        }
                    }

                    if (rotaIptal) {
                        seferler[rotaAdi].iptal = true;
                    }
                    
                    const parcalar = rotaAdi.split('-');
                    if(parcalar.length === 2) {
                        bulunanIskeleler.add(parcalar[0].trim());
                        bulunanIskeleler.add(parcalar[1].trim());
                    }
                }

                iskeleler = Array.from(bulunanIskeleler).sort();
                
                Object.keys(seferler).forEach(r => {
                    seferler[r].haftaici.sort();
                    seferler[r].haftasonu.sort();
                });
                
                resolve();

            } else {
                console.error("XHR HTTP Status:", xhr.status);
                reject(new Error(xhr.statusText));
            }
        };

        xhr.onerror = function() {
            console.error("XHR Connection Error");
            reject(new Error("Connection Error"));
        };

        xhr.send();
    });
}

function verileriGetir() {
    return Promise.all([duyuruyuCek(), rotaVerileriniGetir()]);
}

function menuleriGuncelle() {
    selectOlustur('baslangicSelect');
    selectOlustur('varisSelect');
}

function selectOlustur(id, haric = '') {
    const select = document.getElementById(id);
    const mevcut = select.value;
    
    const placeholderText = id === 'baslangicSelect' ? 'KalkÄ±ÅŸ' : 'VarÄ±ÅŸ';
    select.innerHTML = `<option value="" disabled selected>${placeholderText}</option>`;
    
    if (iskeleler && iskeleler.length > 0) {
        iskeleler.forEach(i => {
            if (i !== haric) {
                const opt = document.createElement('option');
                opt.value = opt.textContent = i;
                select.appendChild(opt);
            }
        });
    }

    if (mevcut && iskeleler.includes(mevcut) && mevcut !== haric) {
         select.value = mevcut;
    } else {
         select.value = '';
    }
}

function degistirYon() {
    const bas = document.getElementById('baslangicSelect');
    const varis = document.getElementById('varisSelect');
    
    const eskiBasDeger = bas.value;
    const eskiVarisDeger = varis.value;

    if (!eskiBasDeger || !eskiVarisDeger || eskiBasDeger === eskiVarisDeger) return; 
    
    bas.value = eskiVarisDeger;
    varis.value = eskiBasDeger;
    
    selectOlustur('baslangicSelect', varis.value); 
    selectOlustur('varisSelect', bas.value);

    bas.value = eskiVarisDeger;
    varis.value = eskiBasDeger;

    gosterSeferler();
}

function gosterSeferler() {
    const b = document.getElementById('baslangicSelect').value;
    const v = document.getElementById('varisSelect').value;
    const g = document.getElementById('gunSelect').value; 
    const s = document.getElementById('sonuc');

    if (!b || !v || b === v) {
         s.innerHTML = '';
         s.classList.add('hidden');
         return;
    }
    
    const istenenRotaAdi = `${b}-${v}`;
    const sefer = seferler[istenenRotaAdi];
    
    const rotaAdlari = sefer ? [istenenRotaAdi] : []; 

    let html = '';
    let rotaBulundu = false;

    rotaAdlari.forEach(rotaAdi => {
        const sefer = seferler[rotaAdi];
        if (!sefer) return;

        const d = sefer?.[g];
        if (!d || d.length === 0) return;

        rotaBulundu = true;
        const nextTwo = d ? findNextTwo(d) : [];

        html += `<div class="rota-kutu">`;
        html += `<div class="rota-baslik"><span>${rotaAdi}</span> <span class="gun-etiketi">${g === 'haftaici' ? 'HAFTA Ä°Ã‡Ä°' : 'HAFTA SONU'}</span></div>`;
        
        if (sefer.iptal) {
             html += `<p style="color:#c62828; font-weight:bold; margin-top:5px">BU ROTA Ä°PTAL EDÄ°LMÄ°ÅžTÄ°R</p>`;
        } else {
             html += `<ul class="sefer-listesi">`;
             d.forEach(t => {
                if(!t) return;
                const isNext = nextTwo.includes(t);
                const cls = ['trip', isNext ? 'next' : '', isTripPassed(t) ? 'passed' : ''].filter(Boolean).join(' ');
                html += `<li class="${cls}">${t}</li>`; 
             });
             html += `</ul>`;
        }
        
        html += `</div>`;
    });

    if (!rotaBulundu) {
        html += `<p class="empty">Bu rota iÃ§in seÃ§ilen gÃ¼ne ait sefer bulunamadÄ±.</p>`;
    }
    
    s.classList.remove('hidden'); 
    s.classList.add('visible'); 
    s.innerHTML = html; 
}

function findNextTwo(list) {
    if(!list) return [];
    const now = new Date().getHours() * 60 + new Date().getMinutes();
    const next = [];
    for (let t of list) {
        if(!t) continue;
        const parts = t.split(':').map(Number);
        if (parts[0] * 60 + parts[1] - now >= 0) next.push({t, diff: parts[0] * 60 + parts[1] - now});
    }
    next.sort((a,b) => a.diff - b.diff);
    return next.slice(0,2).map(x => x.t);
}

function isTripPassed(t) {
    const [h, m] = t.split(':').map(Number);
    const now = new Date().getHours() * 60 + new Date().getMinutes();
    return h * 60 + m < now;
}

// DUYURU GÃ–STER (Sadece metin deÄŸiÅŸtiÄŸinde ve animasyon olmadan tetiklenir)
function duyuruGoster(mesaj) {
    const d = document.getElementById('acil-duyuru');
    
    if (!d) return; 

    if (!mesaj || mesaj.trim() === "") {
        // Duyuru yoksa div'i tamamen gizle
        d.classList.add('hidden');
        d.innerHTML = '';
        return;
    }
    
    // Duyuru varsa div'i gÃ¶ster ve iÃ§eriÄŸi ayarla
    d.classList.remove('hidden');
    d.innerHTML = `<span class="material-icons-round" style="vertical-align:bottom">warning</span> ${mesaj}`;
}

function isResmiTatil() {
    const day = new Date().getDay();
    if (day === 0 || day === 6) return true; 

    const bugun = new Date().toISOString().split('T')[0];
    if (resmiTatiller.includes(bugun)) return true;

    return false;
}

function getGunTipi() {
    if (isResmiTatil()) return 'haftasonu';
    return 'haftaici';
}

function rezervasyonDurumuKontrol() {
    const now = new Date();
    const btn = document.getElementById('rezervasyonBtn');

    // Rezervasyon DÃ¶nemi: 16 MayÄ±s - 22 EylÃ¼l
    const baslangicTarihi = new Date(now.getFullYear(), 4, 16); 
    const bitisTarihi = new Date(now.getFullYear(), 8, 22);   
    
    if (now >= baslangicTarihi && now <= bitisTarihi) {
        btn.disabled = false;
        btn.style.opacity = '1';
        btn.textContent = 'Deniz Seferi Rezervasyon Yap';
        btn.setAttribute('onclick', `window.open('${REZERVASYON_URL}', '_system')`);
    } else {
        btn.disabled = true;
        btn.style.opacity = '0.7';
        btn.textContent = 'Rezervasyon DÃ¶nemi DÄ±ÅŸÄ±nda';
        btn.removeAttribute('onclick');
    }
}

// OTOMATÄ°K ARKA PLAN VERÄ° Ã‡EKME (2 saniye)
function otomatikVeriCek() {
    return verileriGetir() 
    .then(() => {
        rezervasyonDurumuKontrol(); 
    })
    .catch(error => {
        console.error("Otomatik veri Ã§ekme hatasÄ±:", error);
    });
}

// YAVAÅž GÃ–RSEL GÃœNCELLEME (60 saniye)
function gorselGuncelle() {
    gosterSeferler(); 
}

// MANUEL YENÄ°LEME FONKSÄ°YONU (Buton iÃ§in)
function refresher(manualRefresh = false) {
    const refreshIcon = document.getElementById('refreshIcon');
    
    if (manualRefresh && refreshIcon) {
        refreshIcon.classList.add('refreshing');
    }
    
    otomatikVeriCek() 
    .then(() => {
        gosterSeferler(); 
    })
    .finally(() => {
        if (manualRefresh && refreshIcon) {
            setTimeout(() => {
                refreshIcon.classList.remove('refreshing');
            }, 500); 
        }
    });
}

document.addEventListener('DOMContentLoaded', () => {
    rezervasyonDurumuKontrol(); 

    verileriGetir()
    .then(() => {
        // Ä°LK YÃœKLEMEDE MENÃœLERÄ° OLUÅžTUR
        menuleriGuncelle(); 
        
        document.getElementById('gunSelect').value = getGunTipi();
        
        // VarsayÄ±lan seÃ§im ayarÄ±
        let defaultBas = "Ä°zmit";
        let defaultVaris = "GÃ¶lcÃ¼k";

        if (iskeleler.includes(defaultBas) && iskeleler.includes(defaultVaris)) {
            document.getElementById('baslangicSelect').value = defaultBas;
            selectOlustur('varisSelect', defaultBas); 
            document.getElementById('varisSelect').value = defaultVaris;
        } else if (iskeleler.length >= 2) {
            document.getElementById('baslangicSelect').value = iskeleler[0];
            selectOlustur('varisSelect', iskeleler[0]);
            document.getElementById('varisSelect').value = iskeleler[1];
        } 
        
        gosterSeferler();

        // Olay Dinleyicileri
        document.getElementById('gunSelect').addEventListener('change', gosterSeferler);
        
        document.getElementById('baslangicSelect').addEventListener('change', (e) => {
            selectOlustur('varisSelect', e.target.value); 
            gosterSeferler();
        });
        
        document.getElementById('varisSelect').addEventListener('change', gosterSeferler);
    });
});

function updateTime() {
    const n = new Date();
    document.getElementById('liveTime').textContent = `CanlÄ± Saat: ${n.toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'})} â€¢ ${n.toLocaleDateString('tr-TR',{weekday:'short',day:'numeric',month:'short'})}`;
}

// --- OTOMATÄ°K YENÄ°LEME DÃ–NGÃœLERÄ° ---

// 1. ANLIK VERÄ° VE DUYURU KONTROLÃœ (2 saniye)
setInterval(otomatikVeriCek, 2 * 1000); 

// 2. GÃ–RSEL GÃœNCELLEME (60 saniye)
setInterval(gorselGuncelle, 60 * 1000); 

// CanlÄ± saat yenileme dÃ¶ngÃ¼sÃ¼ (1 saniye)
setInterval(updateTime, 1000); updateTime();

</script>
</body>
</html>